name: Update _files.txt

on:
 push:
  branches: [main,master]
 workflow_dispatch: # Add manual trigger

jobs:
 update_files:
  runs-on: ubuntu-latest
  steps:
   - name: Checks out repo.
     uses: actions/checkout@v4
     with:
      token: ${{ secrets.permissions_token }}
      fetch-depth: 0 # Get full history to compare changes

   - name: Get changed directories (skip if manual trigger)
     id: updated_dirs
     if: ${{ github.event_name != 'workflow_dispatch' }}
     run: |
      # Get all changed files in this push
      changed_files=$(git diff --name-only HEAD^ HEAD)
      
      # Extract unique parent directories of changed files
      dirs=()
      for file in $changed_files; do
       dir=$(dirname "$file")
       # Only add directory if not already in array
       if [[ ! " ${dirs[@]} " =~ " ${dir} " ]]; then
        dirs+=("$dir")
       fi
      done
      
      # Convert array to JSON for output
      echo "dirs=${dirs[@]}" | jq -R -s -c 'split(" ")' >> $GITHUB_OUTPUT

   - name: Get all directories with _files.txt (if manual trigger)
     id: all_dirs
     if: ${{ github.event_name == 'workflow_dispatch' }}
     run: |
      # Find all directories containing _files.txt
      dirs=()
      while IFS= read -r -d '' file; do
       dir=$(dirname "$file")
       dirs+=("$dir")
      done < <(find . -name "_files.txt" -print0)
      
      # Convert array to JSON for output
      echo "dirs=${dirs[@]}" | jq -R -s -c 'split(" ")' >> $GITHUB_OUTPUT

   - name: Update _files.txt in target directories
     run: |
      # Use different output based on trigger type
      if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
       changed_dirs=${{ steps.all_dirs.outputs.dirs }}
      else
       changed_dirs=${{ steps.updated_dirs.outputs.dirs }}
      fi
      
      # Convert JSON array to bash array
      eval "dirs=($(echo '$changed_dirs' | jq -r '.[]'))"
      
      for dir in "${dirs[@]}"; do
       # Check if directory contains _files.txt
       if [[ -f "${dir}/_files.txt" ]]; then
        echo "Updating _files.txt in ${dir}"
        (
         cd "$dir" || exit
         find . -maxdepth 1 -type f ! -name "_files.txt" -printf "%P\n" | sort > _files.txt
        )
       fi
      done

   - name: Commit changes if any
     run: |
      git config --global user.name "GitHub Actions"
      git config --global user.email "actions@github.com"
      if [[ -n "$(git status --porcelain)" ]]; then
       git add -A
       git commit -m "Automatically update _files.txt"
       git push
      fi
